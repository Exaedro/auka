<!DOCTYPE html>
<html lang="es" data-id_usuario="<%- usuario.id_usuario %>" data-nombre="<%- usuario.nombre %>" data-apellido="<%- usuario.apellido %>" data-tipo_usuario="<%- usuario.tipo_usuario %>">
<head>
    <%- include('../parciales/head.html') %>
    <link rel="stylesheet" href="panel.css">

    <!-- ICONOS (Font Awesome) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- SOCKET.IO -->
    <script type="module" src="/socket.io/socket.io.js"></script>
    <script type="module">

        const socket = io();

        // Datos del preceptor logeado
        const idPreceptor = document.documentElement.dataset.id_usuario
        const nombrePreceptor = document.documentElement.dataset.nombre
        const apellidoPreceptor = document.documentElement.dataset.apellido
        const tipoUsuario = document.documentElement.dataset.tipo_usuario

        const respuestas = [
            "Yendo", "No puedo", "Derivo otro preceptor"
        ]

        // Elementos HTML
        const llamadosContenedor = document.querySelector('.llamados')

        /* ////////////////////////////////////////////////////////////////// */

        socket.on('nuevo-llamado', (data) => {
            const { usuario: profesor, llamado } = data

            const nuevoLlamado = document.createElement('div');
            nuevoLlamado.classList.add('llamado');
            nuevoLlamado.dataset.usuario_id = profesor.id
            nuevoLlamado.innerHTML = `
                <div class="llamado-cabecera">
                    <p class="llamado-titulo">${profesor.nombre} ${profesor.apellido}</p>
                    <p class="llamado-mensaje">${llamado.mensaje}</p>
                </div>
                <hr>
                <div class="llamado-cuerpo">
                    <p>Llamado - Hace 2 minutos</p>
                </div>
                `

            const llamadoRespuestas = document.createElement('div')
            llamadoRespuestas.classList.add('llamado-respuestas')

            for(const textoRespuesta of respuestas) {
                const respuesta = document.createElement('p')
                respuesta.classList.add('respuesta')
                respuesta.innerText = textoRespuesta
                respuesta.dataset.usuario_id = profesor.id

                respuesta.addEventListener('click', () => {
                    socket.emit('respuesta-llamado', { usuario_id: profesor.id, respuesta: textoRespuesta, nombre: nombrePreceptor, apellido: apellidoPreceptor })
                    mostrarBotonesFinales({ profesor, socket })
                })

                llamadoRespuestas.appendChild(respuesta)
            }
            
            nuevoLlamado.appendChild(llamadoRespuestas)
                
            llamadosContenedor.appendChild(nuevoLlamado)
        })

        /**
         * @param {Object} usuario
         * @param {Socket} socket
         * @returns {void}
         */
        function mostrarBotonesFinales({ profesor, socket }) {
            const respuestas = document.querySelectorAll(`.llamado[data-usuario_id="${profesor.id}"] .respuesta`)
            
            for(const respuesta of respuestas) {
                respuesta.remove()
            }

            const terminado = document.createElement('p')
            terminado.classList.add('respuesta')
            terminado.innerText = 'Terminado'
            terminado.dataset.usuario_id = profesor.id

            terminado.addEventListener('click', () => {
                socket.emit('terminar-llamado', { 
                    usuario_id: profesor.id, 
                    respuesta: "Terminado", 
                    nombre: nombrePreceptor, 
                    apellido: apellidoPreceptor 
                })
                document.querySelector(`.llamado[data-usuario_id="${profesor.id}"]`).remove()
            })

            const llamadoRespuestas = document.querySelector(`.llamado[data-usuario_id="${profesor.id}"] .llamado-respuestas`) 
            llamadoRespuestas.appendChild(terminado)
        }

        /* ////////////////////////////////////////////////////////////////// */

        socket.on('cancelar-llamado', (data) => {
            const { usuario_id: idProfesorLlamado } = data

            const llamado = document.querySelector('.llamado[data-usuario_id="' + idProfesorLlamado + '"]')
            if(llamado) llamado.remove()
        })

        /* ////////////////////////////////////////////////////////////////// */
    </script>
</head>
<body>
    <div class="panel-contenedor">
        <div class="columna columna-izquierda">
            <div class="titulo">
                <h1>Auka</h1>
            </div>
            <div class="historial">
                <p class="historial-titulo">Historial de llamados</p>

                <div class="historial-contenedor">
                    <div class="historial-item">
                        <div>
                            <div class="historial-item-cabecera">
                                <p class="historial-item-titulo">Nombre del emisor</p>
                                <p class="historial-item-hora">10:45 AM</p>
                            </div> 
                            <div class="historial-item-mensaje">
                                <p class="historial-item-texto">
                                    Falta un preceptor en el aula 13 fds fdsdf  
                                </p>
                            </div>
                        </div>
                        <div class="historial-item-pie">
                            <p class="historial-item-estado">
                                <span class="historial-item-estado-texto">Finalizado</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="llamados">
            <!-- <div class="no-hay-llamados">
                <h1>No hay llamados pendientes</h1>
            </div> -->

            <div class="llamado">
                <div class="llamado-cabecera">
                    <p class="llamado-titulo">Nombre del emisor</p>
                    <p class="llamado-mensaje">Falta un preceptor en el aula 13 fds fdsdf</p>
                </div>
                <hr>
                <div class="llamado-cuerpo">
                    <p>Llamado - Hace 2 minutos</p>
                </div>
                <div class="llamado-respuestas">
                    <a class="respuesta" href="#">Yendo</a>
                    <a class="respuesta" href="#">No puedo</a>
                    <a class="respuesta" href="#">Derivo preceptor</a>
                </div>
            </div>
        </div>
        <div class="columna columna-derecha">
            <div class="preceptores">
                <p class="preceptores-titulo">Preceptores activos</p>

                <div class="preceptores-contenedor">
                    <div class="preceptores-item">
                        <img src="img/user.png" alt="">
                        <p>Nombre del preceptor</p>
                    </div>
                    <div class="preceptores-item">
                        <img src="img/user.png" alt="">
                        <p>Nombre del preceptor</p>
                    </div>
                    <div class="preceptores-item">
                        <img src="img/user.png" alt="">
                        <p>Nombre del preceptor</p>
                    </div>
                </div>
            </div>
            <div class="perfil">
                <hr>
                <div class="perfil-info">
                    <p class="perfil-siglas"><%- usuario.nombre[0] %><%- usuario.apellido[0] %></p>
                    <div class="perfil-usuario">
                        <p class="perfil-nombre"><%- usuario.nombre %> <%- usuario.apellido %></p>
                        <p class="perfil-tipo-usuario"><%- usuario.tipo_usuario %></p>
                    </div>
                </div>
                <a class="perfil-cerrar-sesion" href="/logout"><i class="fa-solid fa-right-from-bracket"></i>Cerrar sesi√≥n</a>
            </div>
        </div>
    </div>
</body>
</html>